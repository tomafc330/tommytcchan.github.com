
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Tommy Chan's software blog (@tommytcchan)</title>
  <meta name="author" content="Tommy Chan (informotion software)">

  
  <meta name="description" content="I spend a bit of time today figuring out why the capistrano rbenv gem doesn&#8217;t work. First it was complaining that I had an older version of the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://tommytcchan.github.com/blog/page/2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Tommy Chan's software blog (@tommytcchan)" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38195602-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <link href='http://fonts.googleapis.com/css?family=Ubuntu:400,500' rel='stylesheet' type='text/css'> 
  <meta property="og:url" content="http://tommytcchan.github.com/blog/page/2/index.html">
<meta property="og:type" content="website" />

<meta property="og:title" content="Tommy Chan's software blog (@tommytcchan)">
<meta property="og:description" content="This is a software blog for Tommy Chan.">
 


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Tommy Chan's software blog (@tommytcchan)</a></h1>
  
    <h2>Chronicling my journey through what they call software development.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:tommytcchan.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/01/06/capistrano-3-and-rbenv-sshkit-upgrade-to-1-dot-3/">Capistrano 3 and Rbenv Sshkit Upgrade to 1.3</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-06T17:02:00-08:00" pubdate data-updated="true">Jan 6<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/01/06/capistrano-3-and-rbenv-sshkit-upgrade-to-1-dot-3/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I spend a bit of time today figuring out why the capistrano rbenv gem doesn&#8217;t work. First it was complaining that I had an older version of the sshkit library (it was being used by an older version of the fog library). Upgraded the fob library, but it was complaining of this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cap aborted!
</span><span class='line'>Unable to activate capistrano-rbenv-2.0.0, because sshkit-1.3.0 conflicts with sshkit (~&gt; 1.
</span><span class='line'>2.0)
</span><span class='line'>/home/tchan/repo/venuespot/Capfile:19:in `&lt;top (required)&gt;'
</span><span class='line'>/home/tchan/.rvm/gems/ruby-2.0.0-p247@venuespot/gems/capistrano-3.0.1/lib/capistrano/applica
</span><span class='line'>tion.rb:22:in `load_rakefile'
</span><span class='line'>/home/tchan/.rvm/gems/ruby-2.0.0-p247@venuespot/gems/capistrano-3.0.1/lib/capistrano/applica
</span><span class='line'>tion.rb:12:in `run'</span></code></pre></td></tr></table></div></figure>


<p>After digging through the commit history of the <a href="gem">https://github.com/capistrano/rbenv/pull/21/files</a> I realized it&#8217;s a library version issue.</p>

<p>Uninstall the capistrano gem, then add this in your Gemfile (until the author bumps the version):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'capistrano-rbenv', :git =&gt; 'git@github.com:capistrano/rbenv.git', :ref =&gt; '67222bbce120323e422b051dcd167d8e2d3adbf0'</span></code></pre></td></tr></table></div></figure>


<p>Hope that helps someone!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/01/05/setting-up-rails-with-mixpanel-on-both-the-front-end-and-back-end/">Setting Up Rails With Mixpanel on Both the Front End and Back End</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-05T17:12:00-08:00" pubdate data-updated="true">Jan 5<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/01/05/setting-up-rails-with-mixpanel-on-both-the-front-end-and-back-end/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>At <a href="http://www.venuespot.co">venuespot</a>, we use Mixpanel. We&#8217;ve had an account for awhile actually, but didn&#8217;t really do anything with it. I upgraded our GA to use the new GA script, and needless to say the events management isn&#8217;t that great. That prompted me to look at Mixpanel again. In this article I will explain how one is able to set up events to track individual users going through the system without too much intrusive work.</p>

<h1>The Requirements</h1>

<p>We need a few things we wanted to use with our app:
1.  We want to track the different events that a user takes throughout our site, whether they are logged in or not.
2.  We wanted to blanket track <strong>all</strong> events, such as going to a controller#action.
3.  We don&#8217;t want it to affect the performance of our system too much, which meant hooking into Sidekiq for asynchronous processing.</p>

<h1>The approach</h1>

<p>If you followed the Mixpanel recommendations, they advise you to use the JavaScript library. This was a little limiting for us as we want to track when we send out emails and notifications to the users. So we took a 2 pronged approach:
1.  If the user isn&#8217;t signed in and is just browsing our site, we track those events with the JS client library.
2.  Once they have signed up/in though, we will use server side calls to track the events in an async manner.</p>

<h1>The Setup</h1>

<p>You will need a few things:
1.  Sign up with Mixpanel, and install the javascript.
2.  Place the javascript in your asset pipeline folder and reference it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># application.js
</span><span class='line'>//= require mixpanel/mixpanel</span></code></pre></td></tr></table></div></figure>


<h1>The implementation</h1>

<p>So let&#8217;s start with the part where the user is not logged in but we want to track their actions. We need to tell mixpanel that a new user on our site. Now we will be using <code>localStorage</code> to store our anonymous user.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># venuespot_tracker.js
</span><span class='line'>function VenueSpotTracker() {
</span><span class='line'>
</span><span class='line'>    this.createOrGetUser = function () {
</span><span class='line'>        //check to see if localStorage is defined, omitted for brevity's sake
</span><span class='line'>        ...
</span><span class='line'>
</span><span class='line'>        if (!localStorage.vs_user) {
</span><span class='line'>            localStorage.vs_user = rand(12);
</span><span class='line'>            mixpanel.identify(localStorage.vs_user);
</span><span class='line'>            mixpanel.people.set({
</span><span class='line'>                "$created": new Date(),
</span><span class='line'>                "$last_login": new Date()
</span><span class='line'>            });
</span><span class='line'>        }
</span><span class='line'>        return localStorage.vs_user;
</span><span class='line'>    };
</span><span class='line'>
</span><span class='line'>    this.homePageViewed = function() {
</span><span class='line'>        this.createOrGetUser();
</span><span class='line'>        this.track(document.location.pathname + ' page viewed'); //method omitted for brevity
</span><span class='line'>
</span><span class='line'>        mixpanel.track_links("a", "Clicked Link", {
</span><span class='line'>            referrer: document.referrer
</span><span class='line'>        });
</span><span class='line'>    };
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>var vsTracker = new VenueSpotTracker();
</span><span class='line'>...
</span><span class='line'>vsTracker.homePageViewed();</span></code></pre></td></tr></table></div></figure>


<p>A couple of interesting things&#8230;I omitted some of the code, I&#8217;m sure you can fill in the missing pieces.</p>

<p>Another interesting thing: if there is no user defined, we have to call <code>identify</code> and then set some attributes to let Mixpanel we want to track this anonymous user.</p>

<p>We also want to track all of the links the user clicks, so we use provided <code>track_links</code> method.</p>

<p>Once that&#8217;s done, we just sit back and see the results: http://screencloud.net/v/jLLi</p>

<h3>Sending the info to the backend</h3>

<p>Okay, so far we&#8217;ve got stats on users who have not signed up. What happens when they sign up? We don&#8217;t want to lose the previous history that they had, so we have to call the <code>alias</code> api method after they&#8217;ve logged in so that we can register them. For this we use the <code>mixpanel-ruby</code> gem.</p>

<p>Now you might be asking, why don&#8217;t we just continue to use the JS library? Well I thought about this for a few minutes. If you did that, you would have to make sure that we send over the email down to the client. Also, any time you want to do any tracking you would have to do the same. Finally we also wanted to track the history when we send out emails. That&#8217;s a backend job so that makes it really difficult.</p>

<p>Hopefully I&#8217;ve convinced you of why we want to use the backend library.</p>

<ol>
<li>First thing is to include the gem in your gemfile.</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'mixpanel-ruby'</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Now on the sign up flow, you have to add in a hidden field to the back end registration:</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$(document).ready(function() {
</span><span class='line'>    $('&lt;input&gt;').attr({
</span><span class='line'>        type: 'hidden',
</span><span class='line'>        id: 'mix_panel_temp_id',
</span><span class='line'>        name: 'mix_panel_temp_id',
</span><span class='line'>        value: venuespotTracker.createOrGetUser()
</span><span class='line'>    }).appendTo('form');
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>


<p>We need this because we want to do the alias in the controller:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># create
</span><span class='line'>def create
</span><span class='line'>...
</span><span class='line'>        MixpanelAliasWorker.perform_async(@user.email, params[:mix_panel_temp_id], @user.first_name, @user.last_name, @user.phone, @user.type)
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Notice here we are using Sidekiq to perform our linking in an async manner. The Mixpanel api has a few methods to do with async, but I feel that this is an easier approach.</p>

<p>In MixpanelAliasWorker, this is what happens:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>require 'mixpanel-ruby'
</span><span class='line'>
</span><span class='line'># Does alias and link up the email address
</span><span class='line'>class MixpanelAliasWorker
</span><span class='line'>    include Sidekiq::Worker
</span><span class='line'>
</span><span class='line'>    def mixpanel()
</span><span class='line'>        Mixpanel::Tracker.new(ENV['mix_panel'])
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>    def perform(email, old_id, first_name, last_name, phone, user_type)
</span><span class='line'>        tracker = mixpanel()
</span><span class='line'>        tracker.alias email, old_id #synchrious call
</span><span class='line'>        tracker.people.set(email, {
</span><span class='line'>            '$first_name' =&gt; first_name,
</span><span class='line'>            '$last_name' =&gt; last_name,
</span><span class='line'>            '$email' =&gt; email,
</span><span class='line'>            '$phone' =&gt; phone,
</span><span class='line'>            'User Type' =&gt; user_type
</span><span class='line'>        });
</span><span class='line'>    end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>What happens here is that when a user is registered, we alias the old temp id we created in the front end with the actual email.</p>

<p>Once we do that then Mixpanel will now associate all new events with that email with the previous &#8216;anonymous&#8217; user.</p>

<ol>
<li>Now that we have the user correctly linked, the next step is to track all of the events. For that we will go into the <code>ApplicationController</code> and add this method:</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def track_with_mixpanel
</span><span class='line'>    if (current_user)
</span><span class='line'>
</span><span class='line'>        if params[:id]
</span><span class='line'>            instance = controller_name.classify.constantize.find(params[:id])
</span><span class='line'>            id = instance.respond_to?(:name) ? instance.name : params[:id]
</span><span class='line'>        end
</span><span class='line'>
</span><span class='line'>        MixpanelTrackWorker.perform_async(current_user.email, "Page View - #{self.class.to_s}##{self.instance_variable_get('@_action_name')} #{id}", { :controller =&gt; 'test', :action =&gt; 'test'})
</span><span class='line'>    end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Let me explain what this does. We check that the current user exists, and also check if there is a params[:id]. If there is, we want to know which model that belongs to.</p>

<p>Rails is pretty awesome because you can actually find that out by using <code>controller_name.classify</code>, and then make that into a constant, and finally invoke it to find the model.</p>

<p>I know this isn&#8217;t scalable if we have tens of thousands of users, but our stage we value metrics so in the future this will have to be modified, but it gives us a good tracking for a user and all the actions they do once they are signed in.</p>

<p>Here&#8217;s an example: http://screencloud.net/v/kLnw</p>

<p>So there you have it folks. Ping me if you have any issues with setting this up!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/28/best-practices-with-nginx-and-rails/">Best Practices With Nginx and Rails</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-28T09:08:00-08:00" pubdate data-updated="true">Dec 28<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/12/28/best-practices-with-nginx-and-rails/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>While searching on the internet for a related question, I came across a <a href="https://gist.github.com/mikhailov/3052776">gist</a> that had the best practices for deploying a rails app with unicorn. Please refer to it but I thought I would comment on a few of the best practices that I observed.</p>

<ol>
<li><p>Using the <code>include</code> directive.
This proved to be a great solution for when you want some of your configs checked into source control. You can control the settings without having to muck around in <code>/opt/nginx/conf</code> so you know what you are deploying when you restart nginx.</p></li>
<li><p>Adding the gzip headers to the static resources
The author compiled nginx with <code>--with-http_gzip_static_module</code> which he used later:</p></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  location ~ ^/(assets|images|javascripts|stylesheets|swfs|system)/ {
</span><span class='line'>    gzip_static       on;
</span><span class='line'>    expires           max;
</span><span class='line'>    add_header        Cache-Control public;
</span><span class='line'>    add_header        Last-Modified "";
</span><span class='line'>    add_header        ETag "";
</span><span class='line'> 
</span><span class='line'>    open_file_cache          max=1000 inactive=500s;
</span><span class='line'>    open_file_cache_valid    600s;
</span><span class='line'>    open_file_cache_errors   on;
</span><span class='line'>    break;
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<p>For myself I didn&#8217;t want to add those headers to the <code>assets</code> folder, but for everything it was really sensible to do so.</p>

<ol>
<li>Adding a <code>open_file_cache</code> for static assets. From the above, we can see that there is the <code>open_file_cache</code> decl. This directive sets the cache activity on. This is good when you have a busy server and so you don&#8217;t have to open the file descriptor every time.</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/22/foundation-5-and-reveal-plugin-not-working-issues/">Foundation 5 and Reveal Plugin Not Working Issues</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-22T19:46:00-08:00" pubdate data-updated="true">Dec 22<span>nd</span>, 2013</time>
        
         | <a href="/blog/2013/12/22/foundation-5-and-reveal-plugin-not-working-issues/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;m working on a client project today using the new Foundation 5 version and I had a hard time with trying to get reveal to work.</p>

<p>I followed the docs on how one might be able to run an example. Downloaded the 5.0.2 library and extracted foundation.min.js. Now in the docs it mentions you also need to extract the individual plugins as well. Well guess what I did that and it still didn&#8217;t work.</p>

<p>After digging around the code I realized that the authors already has it in the minifieid version &#8211; by including the library again it somehow screws up and doesn&#8217;t work.</p>

<p>Removed the full <code>foundation.reveal.js</code> to make it work.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/16/rails-and-adding-an-environment-to-headers/">Rails and Adding an Environment to Headers</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-16T19:07:00-08:00" pubdate data-updated="true">Dec 16<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/12/16/rails-and-adding-an-environment-to-headers/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the more annoying things that happens when you have multiple environements is that when a mail comes in, you don&#8217;t really know what is what. Therefore it&#8217;s smart to have an environment shown on the email headers so you don&#8217;t accidentally confuse it with the live system. To do that is relatively trivial:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># base_mailer.rb
</span><span class='line'>class BaseMailer &lt; ActionMailer::Base
</span><span class='line'>
</span><span class='line'>    default from: "hello@venuespot.co" #TODO move these out
</span><span class='line'>    default to: "tom@venuespot.co"
</span><span class='line'>
</span><span class='line'>    def mail(headers={}, &block)
</span><span class='line'>
</span><span class='line'>        unless Rails.env == 'production'
</span><span class='line'>            headers[:subject].insert(0, "[#{Rails.env}] - ")
</span><span class='line'>        end
</span><span class='line'>
</span><span class='line'>        super(headers, &block)
</span><span class='line'>    end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>And then just extend that class instead of the the default <code>ActionMailer::Base</code></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/15/azure-and-confluence-firewall-rule-setup/">Azure and Confluence Firewall Rule Setup Problem and Solution</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-15T21:37:00-08:00" pubdate data-updated="true">Dec 15<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/12/15/azure-and-confluence-firewall-rule-setup/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Our company, VenueSpot.co has a Bizspark account from Microsoft which gives us $150/mn server credit for 3 years. Thanks Microsoft!</p>

<p>However I had to spend some time trying to configure the server esp with the ports so they play nicely. First off you have to enable your firewall, either doing it through <code>iptables</code> or <code>ufc</code>. Initially, I did it using the latter:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo ufw enable
</span><span class='line'>sudo ufw allow 8090</span></code></pre></td></tr></table></div></figure>


<p>So far, so good. I then proceeded to the Azure admin interface to map the port from 8090 => 8090. Guess what that doesn&#8217;t work (at least not for me.)</p>

<p>After some experimentation I go it to work by removing the port 80 => 80 mapping, and instead I created a new mapping that points 80 => 8090.</p>

<p>Coming from an AWS background, this made no sense. Surely I should be able to open any port I wanted&#8230;however that didn&#8217;t work for me.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/15/secret-ingredient-to-a-co-founders-success-love/">Secret Ingredient to a Co-founder&#8217;s Success - Love</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-15T01:09:00-08:00" pubdate data-updated="true">Dec 15<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/12/15/secret-ingredient-to-a-co-founders-success-love/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve been writing a lot of technical stuff previously and it has come to my attention that sooner or later I will have to write about the high level stuff. So let&#8217;s talk about one of the things that is dear and close to me - my significant other. I&#8217;ll have to admit, I joke with ex-coworkers about how much she needs me, but deep down inside she is my rock and without her I would probably have lost focus by now. I have a letter that is addressed to her that I&#8217;d like to share.</p>

<blockquote><p>To my hunny,</p>

<p>I&#8217;m writing to you on my first day of unemployment. Do you remember the last time I was unemployed? I did&#8230;you had to carry our butts for 2 years until I was done school. Fast forward 7 years and here we are all over again&#8230;only this time the stakes are higher.</p>

<p>I feel like this is such a turning point in our lives and I really want to express how thankful I am to have you by my side through thick and thin. You are my everything and I can&#8217;t imagine not having you with me on this journey.</p>

<p>I know the next few months/years will not be easy so I apologize in advance right now for all the hardships that will be coming up. I apologize for those late working nights where I won&#8217;t be able to spend alone time with you. I apologize for all nights that we&#8217;re apart together because I&#8217;m travelling for business. I apologize for all the stupid things I&#8217;ll say after a long day at work. I apologize for boring you with all my talk about how using Puma is better than Unicorn for our Rails server implementation. And last but not least I apologize in advance for making all the sacrifices that you make in order for me to chase my dreams. Please still cook for me during those times.</p>

<p>Now I know there will be some rainy days up ahead but I&#8217;ll hold you tight under my umbrella and we&#8217;ll laugh it off. There will also be those freezing days but in those times I&#8217;ll hold you tighter and we&#8217;ll laugh even harder. I want you to know that whatever the weather is, the sun is always above. In those stormy days I want you to remember those sunny tunes and let these great memories carry us through. Please try to be patient with me and still laugh at my corny jokes. There will also be times where the business doesn&#8217;t go the way we planned and I promise not to let that jeopardize the special relationship that we have. I love you with all my heart and soul and I am so grateful that you are mine. Life is a journey and although sometimes there are obstacles along the way, we will look back and realize that sometimes it&#8217;s not important where we end up, but how we got there.</p>

<p>Love,</p>

<p>Tommy</p></blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/03/jasmine-spies-on-a-2nd-level-object/">Jasmine Spies on a 2nd Level Object</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-03T16:03:00-08:00" pubdate data-updated="true">Dec 3<span>rd</span>, 2013</time>
        
         | <a href="/blog/2013/12/03/jasmine-spies-on-a-2nd-level-object/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve been trying to mock a 2 level object that looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>    mockSoundService = {
</span><span class='line'>        getSound: function () {
</span><span class='line'>            return {
</span><span class='line'>                volume: function () {
</span><span class='line'>                }
</span><span class='line'>            };
</span><span class='line'>        }
</span><span class='line'>    };</span></code></pre></td></tr></table></div></figure>


<p>Naturally, I thought it would work with something like this in my test:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>    spyOn(mockSoundService.getSound(), 'volume');
</span><span class='line'>    service.closeIntroVideo();
</span><span class='line'>
</span><span class='line'>    expect(service.getPlayer()).toBeNull();
</span><span class='line'>    expect(mockSoundService.getSound().volume).toHaveBeenCalled();</span></code></pre></td></tr></table></div></figure>


<p>However, I kept getting errors like these:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Expected a spy, but got undefined.</span></code></pre></td></tr></table></div></figure>


<p>It turns out that you need to break apart the 2nd level object that was nested. Therefore the final product should look something like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>    mockSound = {
</span><span class='line'>        volume: function () {
</span><span class='line'>        }
</span><span class='line'>    };
</span><span class='line'>
</span><span class='line'>    mockSoundService = {
</span><span class='line'>        getSound: function () {
</span><span class='line'>            return mockSound;
</span><span class='line'>        }
</span><span class='line'>    }</span></code></pre></td></tr></table></div></figure>


<p>and now in your mocks you can do something like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>    spyOn(mockSound, 'volume');
</span><span class='line'>    spyOn(mockState, 'go');
</span><span class='line'>    service.closeIntroVideo();</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/21/rails-add-a-custom-migrate-script-for-running-migrations-in-another-location/">Rails: Add a Custom Migrate Script for Running Migrations in Another Location.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-21T19:14:00-07:00" pubdate data-updated="true">Oct 21<span>st</span>, 2013</time>
        
         | <a href="/blog/2013/10/21/rails-add-a-custom-migrate-script-for-running-migrations-in-another-location/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I am currently in the process of refactoring some code in a Rails project for a client, and one of the things that I wanted to do was to separate the database migration scripts that are from the base frameworks (Discourse was used as the base) and the ones I will be adding. This will give a good historical view of all the custom migrations so we don&#8217;t have to go through each one. But in order to do that I had to write my own custom rake task to rake the rake tasks:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>namespace :db do
</span><span class='line'>    desc "Migrate the database by going through the standard migrate folder first, then the custom 1017 folder (options: VERSION=x, VERBOSE=false, SCOPE=blog)."
</span><span class='line'>    task :custom_migrate =&gt; [:environment, :load_config] do
</span><span class='line'>        ActiveRecord::Migration.verbose = ENV["VERBOSE"] ? ENV["VERBOSE"] == "true" : true
</span><span class='line'>        ActiveRecord::Migrator.migrate(ActiveRecord::Migrator.migrations_paths, ENV["VERSION"] ? ENV["VERSION"].to_i : nil) do |migration|
</span><span class='line'>            ENV["SCOPE"].blank? || (ENV["SCOPE"] == migration.scope)
</span><span class='line'>        end
</span><span class='line'>        ActiveRecord::Migrator.migrate('db/migrate/1017', ENV["VERSION"] ? ENV["VERSION"].to_i : nil) do |migration|
</span><span class='line'>            ENV["SCOPE"].blank? || (ENV["SCOPE"] == migration.scope)
</span><span class='line'>        end
</span><span class='line'>
</span><span class='line'>        Rake::Task['db:_dump'].invoke
</span><span class='line'>    end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>Notice the last line where it delegates out to the <code>db:_dump</code> task. This is important as it writes out the schema as the end step.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/05/rails-3-joins-and-not-ins/">Rails 3: Joins and Not Ins</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-05T14:26:00-07:00" pubdate data-updated="true">Oct 5<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/10/05/rails-3-joins-and-not-ins/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>So I needed to write a complexish query for one of the queries for (VenueSpot.co)|[http://www.venuespot.co]. As we are only running a small instance on aws, I didn&#8217;t to waste time by traversing through my related models using <code>each</code>. I wanted to write a couple of more optimizing queries using the <code>joins</code> keyword and the NOT IN mechanism. At the end it looked like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@events = Event.joins(:event_durations).where("events.state = ? and is_published = ? and event_durations.start_date &gt; ? and events.id NOT IN (?)", 'active', true, DateTime.now, @previous_venue_bid_ids).group('events.id')</span></code></pre></td></tr></table></div></figure>


<p>One thing that tripped me up was that initially my <code>@previous_venue_bid_ids</code> was a string that had all the ids, but the api actually takes in an array of the ids, so just be really sure what you are passing is correct!</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/04/08/mongodb-easily-query-on-a-minimum-array-size-of-a-field/">MongoDB - easily query on a minimum array size of a field.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/23/tips-on-foolproofing-your-seo/">Tips on Foolproofing your SEO</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/17/experience-in-a-tech-acclerator-halfway-point/">Experience in a Tech Acclerator - Halfway Point</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/14/rails-issue-with-module-in-lib-folder/">Rails issue with module in lib folder</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/14/rails-3-editing-a-user-object-that-has-a-single-table-inheritance-sti/">Rails 3 - editing a user object that has a Single Table Inheritance STI</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/tommytcchan">@tommytcchan</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'tommytcchan',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("tommytcchan", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/tommytcchan" class="twitter-follow-button" data-show-count="false">Follow @tommytcchan</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/tommytcchan?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Tommy Chan (informotion software) -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'tommyssoftwareblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
